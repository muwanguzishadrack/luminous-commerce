# Luminous CRM - Complete Deployment Guide (Phases 1 & 2)

This guide provides step-by-step instructions to deploy the Luminous CRM application with:
- **Frontend**: Vercel (React + TypeScript + Vite)
- **Backend**: Railway (Express + TypeScript + PostgreSQL)
- **Version Control**: GitHub
- **Auto-deployment**: Enabled for both frontend and backend

## ‚úÖ Latest Implementation Features

### **Enhanced Authentication System**
- **Simplified Registration**: Users only need 6 essential fields (firstName, lastName, businessName, email, phoneNumber, password)
- **Streamlined Login**: Email and password only (no organization slug required)
- **Forgot Password Flow**: Complete email-based password reset with secure tokens
- **Progressive Profile Setup**: Users can complete business details after initial signup

### **Business Profile Management**
- **Auto Organization Creation**: Organizations automatically created from business name during signup
- **Logo Upload Support**: Business logo upload with file validation
- **Complete Address Management**: Street, city, state, zip code, country fields
- **Business Preferences**: Currency and timezone selection
- **Optional Details**: Description, address, and preferences can be completed anytime

### **Frontend Components**
- **RegisterForm**: Simplified 6-field signup form
- **LoginForm**: Clean email/password login with forgot password link
- **ForgotPasswordForm**: Email-based password reset request
- **ResetPasswordForm**: Secure password reset with token validation
- **BusinessProfileForm**: Post-registration business profile completion

### **Security Enhancements**
- **Password Complexity**: Enforced password requirements (8+ chars, upper/lower/number)
- **Secure Reset Tokens**: Time-limited password reset tokens (1 hour expiration)
- **JWT Authentication**: Access and refresh token system
- **Multi-tenant Isolation**: Organization-based data separation

### **File Storage & Upload System**
- **MinIO Object Storage**: S3-compatible storage deployed on Railway
- **Automatic Image Optimization**: Sharp-powered compression and WebP conversion
- **Logo Upload**: Business logo management with real-time validation
- **Progress Tracking**: Visual upload progress indicators
- **Single Bucket Architecture**: Organized storage with folder structure (images/, products/, documents/)
- **File Validation**: MIME type, size, and format checking
- **Automatic Cleanup**: Old files deleted when updating

## Prerequisites

- GitHub account
- Vercel account (free tier works)
- Railway account (free tier with $5 credit)
- Git installed locally
- Node.js 18+ installed

## Step 1: Initialize Git Repository

Since the project is not yet a Git repository, we need to initialize it:

```bash
cd /Users/sir.shadrack/Projects/luminous

# Initialize Git repository
git init

# Create main branch
git checkout -b main

# Add all files
git add .

# Create initial commit
git commit -m "Initial commit: Luminous CRM with authentication and multi-tenancy"
```

## Step 2: Create GitHub Repository

1. Go to [GitHub](https://github.com) and create a new repository
2. Name it `luminous-crm` (or your preferred name)
3. Keep it private or public based on your preference
4. **DO NOT** initialize with README, .gitignore, or license (we already have these)

5. Add the remote origin and push:
```bash
git remote add origin https://github.com/YOUR_USERNAME/luminous-crm.git
git push -u origin main
```

## Step 3: Deploy MinIO Storage to Railway

MinIO provides S3-compatible object storage for handling file uploads (logos, product images, documents).

### 3.1 Deploy MinIO from Railway Template

1. **Go to Railway Dashboard** and click "New Project"
2. **Search for MinIO Template**: Use Railway's template gallery
3. **One-Click Deploy**: Visit https://railway.com/deploy/minio or search "MinIO" in templates
4. **Click "Deploy Now"** to create MinIO instance

### 3.2 MinIO Configuration

Railway automatically configures:
- **MinIO Server**: Main storage service
- **MinIO Console**: Web-based management interface
- **Persistent Volume**: Data storage that survives deployments
- **Environment Variables**: Auto-generated credentials

### 3.3 Access MinIO Credentials

After deployment, Railway provides:
```env
MINIO_ROOT_USER=<auto-generated-username>
MINIO_ROOT_PASSWORD=<auto-generated-password>
MINIO_PUBLIC_HOST=<your-minio-instance>.railway.app
MINIO_PRIVATE_HOST=<internal-railway-network-url>
```

### 3.4 Access MinIO Console

1. **Get Public URL**: Check MinIO Console service in Railway dashboard
2. **Login**: Use the generated `MINIO_ROOT_USER` and `MINIO_ROOT_PASSWORD`
3. **Create Initial Bucket** (optional - backend will auto-create):
   - `luminous-files` (main bucket with folder organization)

### 3.5 Configure MinIO Public Access

For public file access (recommended for production):

1. **Access MinIO Console** via the Railway-provided URL
2. **Go to Administrator ‚Üí Settings**
3. **Set Public Read Policy** for the main bucket if needed for public access
4. **Or use Presigned URLs** for private file access (already implemented)

### üìã MinIO Deployment Checklist

- [ ] MinIO server deployed and running
- [ ] MinIO console accessible
- [ ] Credentials retrieved and saved
- [ ] Public URL noted for backend configuration
- [ ] Main bucket created (optional - auto-created by backend)

---

## Step 4: Deploy Backend to Railway

### 3.1 Create Railway Project

1. Go to [Railway](https://railway.app) and sign in
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Connect your GitHub account if not already connected
5. Select the `luminous-crm` repository
6. Railway will detect the backend folder

### 3.2 Configure Backend Service

1. In Railway dashboard, click on your service
2. Go to "Settings" tab
3. Set the following:
   - **Root Directory**: `/backend`
   - **Build Command**: `npm run build` (auto-detected from railway.json)
   - **Start Command**: `npm start` (auto-detected from railway.json)
   - **Health Check Path**: `/api/health` (auto-detected)

### 3.3 Add PostgreSQL Database

1. In your Railway project, click "New" ‚Üí "Database" ‚Üí "PostgreSQL"
2. Railway will create a PostgreSQL instance
3. Click on the PostgreSQL service to see the connection details

### 3.4 Configure Environment Variables

In your backend service settings, go to "Variables" and add:

```env
# Database (Railway will auto-inject DATABASE_URL from PostgreSQL service)
DATABASE_URL=${{Postgres.DATABASE_URL}}

# JWT Secrets (MUST be unique and secure)
JWT_SECRET=<generate-using-guide-below>
JWT_REFRESH_SECRET=<generate-using-guide-below>
JWT_EXPIRES_IN=24h
JWT_REFRESH_EXPIRES_IN=7d

# Server Configuration
PORT=3000
NODE_ENV=production

# CORS (Update after Vercel deployment)
FRONTEND_URL=https://your-app.vercel.app

# Email Configuration (for password reset - configure based on your email provider)
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_SECURE=false
# SMTP_USER=your-email@gmail.com
# SMTP_PASS=your-app-password
# EMAIL_FROM=noreply@yourdomain.com

# File Upload Configuration
UPLOAD_MAX_SIZE=5242880
UPLOAD_ALLOWED_TYPES=image/jpeg,image/png,image/gif,image/webp

# Password Reset Configuration
PASSWORD_RESET_TOKEN_EXPIRES=3600000

# MinIO Storage Configuration (from Step 3 MinIO deployment)
MINIO_ENDPOINT=https://your-minio-instance.railway.app
MINIO_ACCESS_KEY=<MINIO_ROOT_USER>
MINIO_SECRET_KEY=<MINIO_ROOT_PASSWORD>
MINIO_REGION=us-east-1
MINIO_BUCKET=luminous-files

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
```

### üîê JWT Secrets Generation Guide

JWT secrets are critical for your application's security. They are used to sign and verify authentication tokens. **Never use default or weak secrets in production!**

#### Requirements for JWT Secrets:
- Minimum 32 characters (recommended: 64+ characters)
- Completely random and unpredictable
- Different for JWT_SECRET and JWT_REFRESH_SECRET
- Never commit to version control
- Rotate periodically for security

#### Method 1: OpenSSL (Recommended for macOS/Linux)
```bash
# Generate a 64-character secret
openssl rand -base64 64

# Generate both secrets at once
echo "JWT_SECRET=$(openssl rand -base64 64)"
echo "JWT_REFRESH_SECRET=$(openssl rand -base64 64)"
```

#### Method 2: Node.js (Cross-platform)
```bash
# Generate a 64-character secret
node -e "console.log(require('crypto').randomBytes(48).toString('base64'))"

# Generate both secrets with labels
node -e "
  const crypto = require('crypto');
  console.log('JWT_SECRET=' + crypto.randomBytes(48).toString('base64'));
  console.log('JWT_REFRESH_SECRET=' + crypto.randomBytes(48).toString('base64'));
"
```

#### Method 3: Online Generator (Use with caution)
If you must use an online generator, use reputable ones like:
- https://www.grc.com/passwords.htm
- https://passwordsgenerator.net/

**‚ö†Ô∏è Warning**: Only use online generators for development. For production, always generate secrets locally.

#### Method 4: Password Manager
Most password managers can generate secure random strings:
- 1Password: Use password generator with 64+ characters
- Bitwarden: Use password generator with special characters
- LastPass: Use secure password generator

#### Example of Properly Generated Secrets:
```env
JWT_SECRET=K7wLz9PxR3mN5vB8jT2qA4sG6hY1uC0eF+dW/aXbZcVnMlOiPkQrStUwXyZ123Ab
JWT_REFRESH_SECRET=9mN3vB5xR7wL1zP8jT4qA2sG0hY6uC+eF/dWaXbZcVnMlOiPkQrStUwXyZ789De
```

#### Security Best Practices:
1. **Never reuse secrets** across environments (dev/staging/prod)
2. **Rotate secrets** every 3-6 months
3. **Store securely** in Railway's environment variables
4. **Monitor for leaks** using GitHub secret scanning
5. **Use different secrets** for JWT_SECRET and JWT_REFRESH_SECRET

#### What NOT to do:
‚ùå Use simple strings like "my-secret-key"
‚ùå Use the same secret for multiple environments
‚ùå Commit secrets to Git
‚ùå Share secrets via email or chat
‚ùå Use predictable patterns

### 3.5 Deploy Backend

1. Railway will automatically deploy when you push to GitHub
2. Check the deployment logs in Railway dashboard
3. Once deployed, Railway will provide a URL like: `https://your-app.up.railway.app`
4. Test the health endpoint: `https://your-app.up.railway.app/api/health`

### 3.6 Run Database Migrations

The latest version includes enhanced authentication schema with the following changes:
- **User table**: Added `businessName`, `phoneNumber`, `emailVerified` fields
- **Organization table**: Added `logo`, `state`, `zipCode` fields
- **PasswordResetToken table**: New table for secure password reset functionality

#### Deploy Database Changes Using Railway CLI:

Since you've already installed Railway CLI and connected your project, you can run migrations directly:

```bash
# Connect to your Railway project (already done)
railway link -p a834b8a6-8f88-48bb-b7e1-ec2cd31c16ea

# Run migrations in the backend service context
railway run --service backend npx prisma generate
railway run --service backend npx prisma migrate deploy

# Optional: Seed database with initial data
railway run --service backend npx prisma db seed
```

#### Alternative: Using Railway Dashboard Terminal

1. In Railway dashboard, go to your backend service
2. Click on "Railway CLI" or use the web terminal
3. Run the following commands:

```bash
# Generate Prisma client with updated schema
npx prisma generate

# Deploy database migrations
npx prisma migrate deploy

# Optional: Seed database with initial data
npx prisma db seed
```

#### Verify Database Schema:
```bash
# Check if tables were created correctly
npx prisma studio
```

#### Database Schema Summary:
- ‚úÖ **users**: Enhanced with business information and email verification
- ‚úÖ **organizations**: Updated with logo and address fields  
- ‚úÖ **password_reset_tokens**: New table for secure password resets
- ‚úÖ **Multi-tenant setup**: Organization-based data isolation

#### Migration Troubleshooting:
If migrations fail, you can reset the database (‚ö†Ô∏è **ONLY for development**):
```bash
# Reset database (destroys all data)
npx prisma migrate reset --force

# Then deploy migrations
npx prisma migrate deploy
```

## Step 4: Deploy Frontend to Vercel

### 4.1 Connect to Vercel

1. Go to [Vercel](https://vercel.com) and sign in
2. Click "Add New..." ‚Üí "Project"
3. Import your `luminous-crm` repository from GitHub
4. Vercel will detect the frontend folder

### 4.2 Configure Frontend Deployment

1. In the configuration screen:
   - **Framework Preset**: Vite
   - **Root Directory**: `frontend`
   - **Build Command**: `npm run build`
   - **Output Directory**: `dist`
   - **Install Command**: `npm install`

### 4.3 Configure Environment Variables

Add the following environment variables in Vercel:

```env
VITE_API_BASE_URL=https://your-backend.up.railway.app/api
VITE_APP_NAME=Luminous CRM
VITE_APP_VERSION=1.0.0
```

Replace `your-backend.up.railway.app` with your actual Railway backend URL.

### 4.4 Deploy Frontend

1. Click "Deploy"
2. Vercel will build and deploy your frontend
3. You'll get a URL like: `https://luminous-crm.vercel.app`

## Step 5: Update Backend CORS

After getting your Vercel URL, update the backend environment variable in Railway:

1. Go to Railway dashboard ‚Üí Backend service ‚Üí Variables
2. Update:
```env
FRONTEND_URL=https://luminous-crm.vercel.app
```
3. Railway will automatically redeploy with the new configuration

## Step 6: Enable Auto-deployment

Both platforms enable auto-deployment by default:

### Vercel
- Automatically deploys on push to `main` branch
- Creates preview deployments for pull requests
- Configure branch deployments in Project Settings ‚Üí Git

### Railway
- Automatically deploys on push to `main` branch
- Configure in service Settings ‚Üí Deploy ‚Üí Automatic Deploys

## Step 7: Set Up GitHub Actions (Optional)

Create CI/CD workflows to run tests before deployment:

### Frontend CI Workflow

Create `.github/workflows/frontend-ci.yml`:

```yaml
name: Frontend CI

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run linter
      run: |
        cd frontend
        npm run lint
        
    - name: Build
      run: |
        cd frontend
        npm run build
```

### Backend CI Workflow

Create `.github/workflows/backend-ci.yml`:

```yaml
name: Backend CI

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        cd backend
        npm ci
        
    - name: Generate Prisma Client
      run: |
        cd backend
        npx prisma generate
        
    - name: Build
      run: |
        cd backend
        npm run build
```

Commit and push these workflows:
```bash
git add .github/
git commit -m "Add GitHub Actions CI workflows"
git push
```

## Step 8: Test Your Deployment

### Backend Testing

1. Test health endpoint:
```bash
curl https://your-backend.up.railway.app/api/health
```

2. Test authentication endpoints:
```bash
# Register a new user
curl -X POST https://your-backend.up.railway.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "SecurePass123!",
    "firstName": "Test",
    "lastName": "User"
  }'
```

### Frontend Testing

1. Visit your Vercel URL: `https://luminous-crm.vercel.app`
2. Try registering a new account
3. Login with the created account
4. Create an organization
5. Navigate through the dashboard

## ‚úÖ Testing New Authentication Features

After deployment, test these enhanced authentication flows:

### **1. User Registration Flow**
1. **Go to registration page**: `https://your-app.vercel.app/register`
2. **Fill out simplified form**:
   - First Name: "John"
   - Last Name: "Doe"  
   - Business Name: "Acme Corp"
   - Email: "john@example.com"
   - Phone Number: "+1234567890"
   - Password: "SecurePass123"
   - Confirm Password: "SecurePass123"
3. **Verify auto-redirect** to dashboard after successful registration
4. **Check organization creation**: User should belong to "Acme Corp" organization

### **2. Login Flow**
1. **Go to login page**: `https://your-app.vercel.app/login`
2. **Test simplified login**:
   - Email: "john@example.com"
   - Password: "SecurePass123"
3. **Verify successful authentication** and dashboard access
4. **Test "Forgot Password?" link** is visible and functional

### **3. Forgot Password Flow**
1. **Click "Forgot Password?" link** on login page
2. **Enter email address** of existing user
3. **Verify success message** appears (even if email isn't actually sent yet)
4. **Check backend logs** for password reset token generation
5. **Test reset link format**: `https://your-app.vercel.app/reset-password?token=<token>`

### **4. Business Profile Setup**
1. **After registration**, look for business profile completion option
2. **Test optional fields**:
   - Business Description
   - Logo Upload (test file validation)
   - Address fields (street, city, state, zip, country)
   - Currency selection (default: USD)
   - Timezone selection (default: UTC)
3. **Verify "Skip for now"** option works
4. **Test profile completion** saves correctly

### **5. Logo Upload Testing**
1. **Access business profile** form
2. **Test file upload**:
   - ‚úÖ Valid formats: JPG, PNG, GIF, WebP
   - ‚ùå Invalid formats: PDF, TXT, etc.
   - ‚ùå Files over 5MB
3. **Verify preview** shows uploaded image
4. **Test delete logo** functionality

### **6. API Endpoint Testing**

Use tools like Postman or curl to test:

```bash
# Health check
curl https://your-backend.up.railway.app/api/health

# Registration
curl -X POST https://your-backend.up.railway.app/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "Test",
    "lastName": "User", 
    "businessName": "Test Business",
    "email": "test@example.com",
    "phoneNumber": "+1234567890",
    "password": "TestPass123",
    "confirmPassword": "TestPass123"
  }'

# Login  
curl -X POST https://your-backend.up.railway.app/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "TestPass123"
  }'
```

### **7. Database Verification**

Check Railway PostgreSQL to verify:
- ‚úÖ **users table** has new fields: `businessName`, `phoneNumber`, `emailVerified`
- ‚úÖ **organizations table** has: `logo`, `state`, `zipCode` fields
- ‚úÖ **password_reset_tokens table** exists
- ‚úÖ **Organization created** automatically during user registration
- ‚úÖ **User assigned OWNER role** for their organization

### **8. Security Testing**
- **Test password complexity**: Should reject weak passwords
- **Test email validation**: Should reject invalid email formats
- **Test duplicate registration**: Should prevent duplicate emails
- **Test JWT tokens**: Should receive access and refresh tokens
- **Test protected routes**: Should require authentication

### **9. Frontend Component Testing**
Navigate and test all new components:
- ‚úÖ `/register` - RegisterForm with 6 fields
- ‚úÖ `/login` - LoginForm with forgot password link
- ‚úÖ `/forgot-password` - ForgotPasswordForm
- ‚úÖ `/reset-password?token=...` - ResetPasswordForm
- ‚úÖ Business profile setup (accessible from dashboard)

### **10. Mobile Responsiveness**
Test all forms on mobile devices:
- ‚úÖ Forms should be responsive
- ‚úÖ All fields should be accessible
- ‚úÖ Buttons should be touch-friendly
- ‚úÖ File upload should work on mobile

---

## Step 9: Monitoring & Maintenance

### Railway Monitoring
- View logs: Railway Dashboard ‚Üí Service ‚Üí Logs
- Monitor metrics: Railway Dashboard ‚Üí Service ‚Üí Metrics
- Set up alerting in Railway settings

### Vercel Monitoring
- View build logs: Vercel Dashboard ‚Üí Project ‚Üí Functions
- Monitor analytics: Vercel Dashboard ‚Üí Analytics
- Set up custom domains in project settings

### Database Backups
Railway PostgreSQL includes automatic daily backups. For additional backup strategies:
1. Use Railway's backup features
2. Set up periodic `pg_dump` commands
3. Configure point-in-time recovery if needed

## Troubleshooting

### Common Issues

1. **Database Connection Errors**
   - Ensure DATABASE_URL is properly set in Railway
   - Check if migrations have been run
   - Verify PostgreSQL service is running

2. **CORS Errors**
   - Ensure FRONTEND_URL in backend matches your Vercel URL
   - Check if backend has been redeployed after updating FRONTEND_URL

3. **Build Failures**
   - Check build logs in Railway/Vercel
   - Ensure all dependencies are in package.json
   - Verify TypeScript has no compilation errors

4. **Authentication Issues**
   - Verify JWT secrets are set correctly
   - Check if tokens are being sent in requests
   - Ensure backend URL is correct in frontend env

5. **File Upload Issues**
   - Verify MinIO service is running and accessible
   - Check MINIO_ENDPOINT, MINIO_ACCESS_KEY, and MINIO_SECRET_KEY are set correctly
   - Ensure buckets are created (backend auto-creates them)
   - Verify file size limits in both frontend and backend
   - Check MinIO console for uploaded files

6. **MinIO Storage Issues**
   - Check MinIO service status in Railway dashboard
   - Verify MinIO credentials match between services
   - Test MinIO console access with provided credentials
   - Check bucket policies for public/private access
   - Monitor MinIO logs for upload errors

## Security Checklist

- [ ] Use strong, unique JWT secrets
- [ ] Enable HTTPS (automatic on both platforms)
- [ ] Keep environment variables secure
- [ ] Regularly update dependencies
- [ ] Monitor for security alerts on GitHub
- [ ] Use Railway's private networking for database and MinIO
- [ ] Enable 2FA on GitHub, Vercel, and Railway accounts
- [ ] Configure MinIO bucket policies appropriately
- [ ] Monitor file upload activity and storage usage
- [ ] Set up file size and type restrictions
- [ ] Use secure MinIO credentials (auto-generated by Railway)

## Next Steps

After successful deployment of Phases 1 & 2:

1. **Set up monitoring**:
   - Add error tracking (e.g., Sentry)
   - Set up uptime monitoring
   - Configure performance monitoring

2. **Optimize performance**:
   - Enable caching headers
   - Optimize database queries
   - Add Redis for session management (Phase 3)

3. **Prepare for Phase 3**:
   - Review WhatsApp Business API requirements
   - Plan WebSocket infrastructure for real-time features
   - Set up media storage solution (Cloudinary/S3)

## Deployment Costs

### Estimated Monthly Costs

**Vercel (Frontend)**:
- Free tier: 100GB bandwidth, unlimited deployments
- Sufficient for small-medium applications

**Railway (Backend + Storage)**:
- Free tier: $5 credit/month
- Estimated usage: ~$10-15/month for small application
- Includes: 
  - Backend Server ($5)
  - PostgreSQL Database ($5)
  - MinIO Storage ($2-5 depending on usage)

**Storage Costs**:
- MinIO: Pay for compute time and storage used
- Estimated: 1GB storage + minimal compute = ~$2-5/month
- Scales with actual usage (files uploaded/downloaded)
- Single bucket approach reduces complexity and potential costs

**Total**: $0-15/month for initial deployment with file storage

---

## Support

If you encounter issues:
1. Check Railway and Vercel documentation
2. Review deployment logs
3. Ensure all environment variables are set correctly
4. Verify your code works locally before deploying

Your Luminous CRM with authentication, multi-tenancy, and file storage is now deployed and ready for use!

## üéâ Deployment Complete!

You now have a fully functional CRM system with:
- ‚úÖ **Authentication**: User registration, login, password reset
- ‚úÖ **Multi-tenancy**: Organization-based data isolation
- ‚úÖ **File Storage**: Logo uploads with MinIO object storage
- ‚úÖ **Image Optimization**: Automatic compression and format conversion
- ‚úÖ **Progressive UX**: Quick signup with optional business profile completion
- ‚úÖ **Production Ready**: Deployed on Railway and Vercel with HTTPS